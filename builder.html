<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Trip Builder</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
<style>
    body { font-family: -apple-system, sans-serif; background: #f3f4f6; padding: 20px; padding-bottom: 120px; }
    .container { max-width: 900px; margin: 0 auto; }
    .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; position: relative; }
    .input-field { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 5px; }
    .btn { padding: 8px 16px; border-radius: 6px; font-weight: bold; cursor: pointer; border: none; color: white; transition: 0.2s; }
    .btn-blue { background: #3b82f6; }
    .btn-green { background: #10b981; width: 100%; padding: 15px; font-size: 1.1rem; box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3); }
    .btn-red { background: #ef4444; font-size: 0.75rem; padding: 4px 8px; }
    .btn-gray { background: #6b7280; }
    
    /* ì–¸ì–´ ì „í™˜ ë²„íŠ¼ */
    .lang-btn { position: absolute; top: 20px; right: 20px; background: #e5e7eb; color: #374151; padding: 6px 12px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 0.8rem; }
    .lang-btn:hover { background: #d1d5db; }

    .day-block { border: 2px solid #e5e7eb; border-radius: 12px; padding: 20px; margin-bottom: 25px; background: #fff; position: relative; overflow: hidden; }
    .day-block::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 6px; background: #3b82f6; } 
    .day-block:nth-child(even) { background-color: #f8fafc; border-color: #cbd5e1; }
    .day-block:nth-child(even)::before { background: #6366f1; }

    .plan-tab { display: flex; gap: 5px; margin-bottom: 10px; border-bottom: 2px solid #e5e7eb; padding-bottom: 10px; }
    .tab-btn { flex: 1; padding: 10px; text-align: center; border-radius: 8px; cursor: pointer; font-weight: bold; color: #6b7280; background: #fff; border: 1px solid #e5e7eb; font-size: 0.9rem; transition: 0.2s; }
    
    .tab-btn.active-common { background: #fef9c3; color: #854d0e; border-color: #fde047; box-shadow: 0 2px 0 #facc15; transform: translateY(-2px); }
    .tab-btn.active-a { background: #eff6ff; color: #2563eb; border-color: #bfdbfe; box-shadow: 0 2px 0 #60a5fa; transform: translateY(-2px); }
    .tab-btn.active-b { background: #fff1f2; color: #db2777; border-color: #fecdd3; box-shadow: 0 2px 0 #fb7185; transform: translateY(-2px); }
    .tab-btn.active-c { background: #ecfdf5; color: #059669; border-color: #a7f3d0; box-shadow: 0 2px 0 #34d399; transform: translateY(-2px); }

    .event-item { background: #fff; padding: 12px; border-radius: 8px; margin-bottom: 8px; border: 1px solid #eee; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    .event-item.is-common { border-left: 4px solid #eab308; background: #fffbeb; } 
    .event-item.plan-b { border-left: 4px solid #ec4899; background: #fff1f2; }
    .event-item.plan-c { border-left: 4px solid #10b981; background: #ecfdf5; }
    
    .time-select-group { display: flex; align-items: center; gap: 2px; }
    .time-select { width: 48px; padding: 6px 2px; border: 1px solid #ddd; border-radius: 4px; text-align: center; }
</style>
</head>
<body>

<div class="container">
    <div class="flex justify-between items-center mb-6 relative">
        <h1 class="text-2xl font-bold text-gray-800" id="lbl-main-title">ğŸ§³ ì—¬í–‰ ê³„íš ë¹Œë”</h1>
        <div class="flex gap-2 items-center">
            <button onclick="toggleLang()" class="lang-btn">ğŸ‡°ğŸ‡·/ğŸ‡ºğŸ‡¸</button>
            <button onclick="saveWork()" class="btn btn-gray text-xs" id="btn-save">ì„ì‹œ ì €ì¥</button>
        </div>
    </div>

    <!-- 1. ê¸°ë³¸ ì„¤ì • -->
    <div class="card">
        <h2 class="text-xl font-bold mb-4" id="lbl-basic">1. ê¸°ë³¸ ì„¤ì •</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label class="font-bold text-sm text-gray-600" id="lbl-trip-title">ì—¬í–‰ ì œëª©</label>
                <input type="text" id="appTitle" class="input-field" oninput="tripData.title=this.value" placeholder="Title">
            </div>
            <div>
                <label class="font-bold text-sm text-gray-600" id="lbl-theme">í…Œë§ˆ ìƒ‰ìƒ</label>
                <select id="themeColor" class="input-field" onchange="tripData.theme=this.value">
                    <option value="blue">Blue (Default)</option>
                    <option value="pink">Pink (Sakura)</option>
                    <option value="green">Green (Nature)</option>
                    <option value="purple">Purple (Night)</option>
                </select>
            </div>
        </div>

        <div class="mt-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
            <div class="flex items-center gap-2 mb-3">
                <input type="checkbox" id="chkMultiPlan" class="w-5 h-5" onchange="toggleMultiPlan()">
                <label for="chkMultiPlan" class="font-bold text-gray-800 cursor-pointer select-none" id="lbl-multi">ğŸ”„ ë©€í‹° í”Œëœ(A/B) ì‚¬ìš©</label>
            </div>
            <div id="multiPlanInputs" class="grid grid-cols-3 gap-2" style="display:none;">
                <div><label class="text-xs text-blue-600 font-bold">Plan A</label><input type="text" id="planAName" class="input-field" placeholder="Rent Car" oninput="tripData.planA=this.value"></div>
                <div><label class="text-xs text-pink-600 font-bold">Plan B</label><input type="text" id="planBName" class="input-field" placeholder="Bus/Train" oninput="tripData.planB=this.value"></div>
                <div><label class="text-xs text-green-600 font-bold">Plan C</label><input type="text" id="planCName" class="input-field" placeholder="Taxi" oninput="tripData.planC=this.value"></div>
            </div>
        </div>
    </div>

    <!-- 2. ì²´í¬ë¦¬ìŠ¤íŠ¸ -->
    <div class="card">
        <h2 class="text-xl font-bold mb-4" id="lbl-check">2. ì²´í¬ë¦¬ìŠ¤íŠ¸</h2>
        <div id="check-list"></div>
        <button onclick="addCheck()" class="btn btn-blue text-sm mt-2" id="btn-add-check">+ í•­ëª© ì¶”ê°€</button>
    </div>

    <!-- 3. ì¼ì • ê´€ë¦¬ -->
    <div class="card">
        <h2 class="text-xl font-bold mb-4" id="lbl-sch">3. ìƒì„¸ ì¼ì • (ìµœëŒ€ 10ì¼)</h2>
        <p class="text-sm text-gray-500 mb-4" id="lbl-sch-desc">ğŸ’¡ Plan Aì—ì„œ <b>[ğŸ‘‘ ì „ì²´ ì ìš©]</b> ì²´í¬ ì‹œ ê³µí†µ ì¼ì •ìœ¼ë¡œ ì„¤ì •ë©ë‹ˆë‹¤.</p>
        <div id="days-container"></div>
        <button onclick="addDay()" class="btn btn-blue w-full mt-4" id="btn-add-day">+ ë‚ ì§œ(Day) ì¶”ê°€</button>
    </div>

    <!-- 4. ì •ë³´ ê´€ë¦¬ -->
    <div class="card">
        <h2 class="text-xl font-bold mb-4" id="lbl-info">4. ìœ ìš©í•œ ì •ë³´</h2>
        <div id="info-list"></div>
        <button onclick="addInfo()" class="btn btn-blue text-sm mt-2" id="btn-add-info">+ ì •ë³´ ì¶”ê°€</button>
    </div>
</div>

<div class="fixed bottom-0 left-0 w-full p-4 bg-white border-t shadow-lg z-50">
    <div class="container flex gap-2">
        <button onclick="openApp()" class="btn btn-green flex-1" id="btn-launch">ğŸš€ ì•± ì‹¤í–‰</button>
        <button onclick="copyLink()" class="btn btn-dark w-24" id="btn-copy">ğŸ”— ë³µì‚¬</button>
    </div>
</div>

<script>
    // --- ë‹¤êµ­ì–´ ë°ì´í„° ---
    const LANG = {
        ko: {
            mainTitle: "ğŸ§³ ì—¬í–‰ ê³„íš ë¹Œë”", save: "ì„ì‹œ ì €ì¥",
            basic: "1. ê¸°ë³¸ ì„¤ì •", tripTitle: "ì—¬í–‰ ì œëª©", theme: "í…Œë§ˆ ìƒ‰ìƒ",
            multi: "ğŸ”„ ë©€í‹° í”Œëœ(A/B ì„ íƒ) ì‚¬ìš©í•˜ê¸°",
            check: "2. ì²´í¬ë¦¬ìŠ¤íŠ¸", addCheck: "+ í•­ëª© ì¶”ê°€",
            sch: "3. ìƒì„¸ ì¼ì • (ìµœëŒ€ 10ì¼)", schDesc: "ğŸ’¡ Plan Aì—ì„œ <b>[ğŸ‘‘ ì „ì²´ ì ìš©]</b>ì„ ì²´í¬í•˜ë©´ ë‹¤ë¥¸ í”Œëœì—ë„ ìë™ìœ¼ë¡œ ë³´ì…ë‹ˆë‹¤.", addDay: "+ ë‚ ì§œ(Day) ì¶”ê°€",
            info: "4. ìœ ìš©í•œ ì •ë³´", addInfo: "+ ì •ë³´ ì¶”ê°€",
            launch: "ğŸš€ ì•± ì‹¤í–‰", copy: "ğŸ”— ë³µì‚¬",
            day: "Day", del: "ì‚­ì œ", common: "ğŸ‘‘ ê³µí†µ", applyAll: "ğŸ‘‘ ë‹¤ë¥¸ í”Œëœì—ë„ ì ìš©",
            phTitle: "ì œëª©", phDesc: "ì„¤ëª…", phMap: "ì§€ë„ ê²€ìƒ‰ì–´", phCheck: "ì¤€ë¹„ë¬¼", phName: "ì´ë¦„", phVal: "ê°’"
        },
        en: {
            mainTitle: "ğŸ§³ Trip Builder", save: "Save Draft",
            basic: "1. Basic Settings", tripTitle: "Trip Title", theme: "Theme Color",
            multi: "ğŸ”„ Use Multi-Plan (A/B)",
            check: "2. Checklist", addCheck: "+ Add Item",
            sch: "3. Itinerary (Max 10 Days)", schDesc: "ğŸ’¡ Check <b>[ğŸ‘‘ Apply All]</b> in Plan A to make it a common event.", addDay: "+ Add Day",
            info: "4. Useful Info", addInfo: "+ Add Info",
            launch: "ğŸš€ Launch App", copy: "ğŸ”— Copy",
            day: "Day", del: "Del", common: "ğŸ‘‘ Common", applyAll: "ğŸ‘‘ Apply All Plans",
            phTitle: "Title", phDesc: "Description", phMap: "Map Query", phCheck: "Item", phName: "Name", phVal: "Value"
        }
    };

    let currentLang = localStorage.getItem('builder_lang') || 'ko';

    let tripData = {
        title: "ë‚˜ë§Œì˜ ì—¬í–‰", theme: "blue", useMulti: false,
        planA: "", planB: "", planC: "",
        checks: [{text:"", type:"all"}],
        days: [{ 
            date: "1ì¼ì°¨", title: "", 
            eventsA: [{time:"10:00", icon:"âœˆï¸", type:"fly", title:"Airport", desc:"Arrival", map:"", isCommon: true}], 
            eventsB: [], eventsC: [] 
        }],
        infos: [{ label: "Police (110)", val: "110", type: "tel" }]
    };

    const iconOpts = [
        {v:"fly", l:"âœˆï¸"}, {v:"bus", l:"ğŸšŒ"}, {v:"train", l:"ğŸš†"},
        {v:"car", l:"ğŸš—"}, {v:"food", l:"ğŸ”"}, {v:"beer", l:"ğŸº"},
        {v:"camera", l:"ğŸ“·"}, {v:"shop", l:"ğŸ›ï¸"}, {v:"bed", l:"ğŸ›ï¸"}, {v:"map", l:"ğŸ“"}
    ];

    function toggleLang() {
        currentLang = (currentLang === 'ko' ? 'en' : 'ko');
        localStorage.setItem('builder_lang', currentLang);
        render();
    }

    function applyLang() {
        const L = LANG[currentLang];
        document.getElementById('lbl-main-title').innerText = L.mainTitle;
        document.getElementById('btn-save').innerText = L.save;
        document.getElementById('lbl-basic').innerText = L.basic;
        document.getElementById('lbl-trip-title').innerText = L.tripTitle;
        document.getElementById('lbl-theme').innerText = L.theme;
        document.getElementById('lbl-multi').innerText = L.multi;
        document.getElementById('lbl-check').innerText = L.check;
        document.getElementById('btn-add-check').innerText = L.addCheck;
        document.getElementById('lbl-sch').innerText = L.sch;
        document.getElementById('lbl-sch-desc').innerHTML = L.schDesc;
        document.getElementById('btn-add-day').innerText = L.addDay;
        document.getElementById('lbl-info').innerText = L.info;
        document.getElementById('btn-add-info').innerText = L.addInfo;
        document.getElementById('btn-launch').innerText = L.launch;
        document.getElementById('btn-copy').innerText = L.copy;
    }

    function getHourOpts(selected) {
        let html = '';
        for(let i=0; i<24; i++) {
            let val = i.toString().padStart(2, '0');
            html += `<option value="${val}" ${selected===val?'selected':''}>${val}</option>`;
        }
        return html;
    }
    function getMinOpts(selected) {
        let html = '';
        for(let i=0; i<60; i+=5) {
            let val = i.toString().padStart(2, '0');
            html += `<option value="${val}" ${selected===val?'selected':''}>${val}</option>`;
        }
        return html;
    }

    function toggleMultiPlan() {
        tripData.useMulti = document.getElementById('chkMultiPlan').checked;
        document.getElementById('multiPlanInputs').style.display = tripData.useMulti ? 'grid' : 'none';
        render(); 
    }

    function render() {
        applyLang(); // ì–¸ì–´ ì ìš©
        const L = LANG[currentLang];

        document.getElementById('appTitle').value = tripData.title;
        document.getElementById('themeColor').value = tripData.theme;
        document.getElementById('chkMultiPlan').checked = tripData.useMulti;
        document.getElementById('multiPlanInputs').style.display = tripData.useMulti ? 'grid' : 'none';
        document.getElementById('planAName').value = tripData.planA;
        document.getElementById('planBName').value = tripData.planB;
        document.getElementById('planCName').value = tripData.planC;

        const cList = document.getElementById('check-list');
        cList.innerHTML = '';
        tripData.checks.forEach((c, i) => {
            let typeOpts = `<option value="all">All</option>`;
            if(tripData.useMulti) typeOpts += `<option value="A">Plan A</option><option value="B">Plan B</option><option value="C">Plan C</option>`;
            cList.innerHTML += `<div class="flex gap-2 mb-2"><input class="input-field flex-1" value="${c.text}" placeholder="${L.phCheck}" oninput="tripData.checks[${i}].text=this.value"><select class="input-field w-28" onchange="tripData.checks[${i}].type=this.value" style="font-size:0.8rem;">${typeOpts}</select><button class="btn btn-red" onclick="tripData.checks.splice(${i},1); render();">${L.del}</button></div>`;
            cList.querySelectorAll('select')[i].value = c.type || 'all';
        });

        const dCont = document.getElementById('days-container');
        dCont.innerHTML = '';
        tripData.days.forEach((d, dIdx) => {
            const activeTab = d._activeTab || 'A';
            const nameA = tripData.useMulti ? (tripData.planA || 'Plan A') : 'Schedule';

            let tabHtml = `<div class="plan-tab">`;
            tabHtml += `<div class="tab-btn ${activeTab==='A'?'active-a':''}" onclick="switchDayTab(${dIdx}, 'A')">${nameA}</div>`;
            if(tripData.useMulti) {
                tabHtml += `<div class="tab-btn ${activeTab==='B'?'active-b':''}" onclick="switchDayTab(${dIdx}, 'B')">${tripData.planB||'Plan B'}</div>`;
                tabHtml += `<div class="tab-btn ${activeTab==='C'?'active-c':''}" onclick="switchDayTab(${dIdx}, 'C')">${tripData.planC||'Plan C'}</div>`;
            }
            tabHtml += `</div>`;

            const div = document.createElement('div');
            div.className = 'day-block';
            div.innerHTML = `
                <div class="flex justify-between items-end mb-4">
                    <div class="w-1/3"><label class="text-xs font-bold text-gray-500">${L.day} ${dIdx+1}</label><input class="input-field font-bold" value="${d.date}" onchange="updateDay(${dIdx}, 'date', this.value)"></div>
                    <div class="w-1/2 ml-2"><label class="text-xs font-bold text-gray-500">Theme</label><input class="input-field" value="${d.title}" onchange="updateDay(${dIdx}, 'title', this.value)"></div>
                    <button class="btn btn-red h-8 ml-2" onclick="removeDay(${dIdx})">${L.del}</button>
                </div>
                ${tabHtml}
                <div style="display:${activeTab==='A'?'block':'none'}">${renderEvents(d.eventsA, dIdx, 'A')}<button class="w-full py-2 border-2 border-dashed border-blue-200 text-blue-500 rounded text-sm hover:bg-blue-50" onclick="addEvent(${dIdx}, 'A')">+ ${nameA}</button></div>
                <div style="display:${activeTab==='B'?'block':'none'}">${renderEvents(d.eventsB, dIdx, 'B')}<button class="w-full py-2 border-2 border-dashed border-pink-200 text-pink-500 rounded text-sm hover:bg-pink-50" onclick="addEvent(${dIdx}, 'B')">+ Add</button></div>
                <div style="display:${activeTab==='C'?'block':'none'}">${renderEvents(d.eventsC, dIdx, 'C')}<button class="w-full py-2 border-2 border-dashed border-green-200 text-green-500 rounded text-sm hover:bg-green-50" onclick="addEvent(${dIdx}, 'C')">+ Add</button></div>
            `;
            dCont.appendChild(div);
        });

        const iCont = document.getElementById('info-list');
        iCont.innerHTML = '';
        tripData.infos.forEach((info, i) => {
            iCont.innerHTML += `<div class="flex gap-2 mb-2 items-center bg-gray-50 p-2 rounded border"><select class="input-field w-24" onchange="tripData.infos[${i}].type=this.value"><option value="tel">Tel</option><option value="link">Link</option></select><input class="input-field w-1/3" value="${info.label}" placeholder="${L.phName}" oninput="tripData.infos[${i}].label=this.value"><input class="input-field flex-1" value="${info.val}" placeholder="${L.phVal}" oninput="tripData.infos[${i}].val=this.value"><button class="btn btn-red" onclick="tripData.infos.splice(${i},1); render();">X</button></div>`;
            iCont.querySelectorAll('select')[i].value = info.type;
        });
    }

    function renderEvents(events, dIdx, planType) {
        if(!events) return '';
        const L = LANG[currentLang];
        let typeClass = planType === 'B' ? 'plan-b' : (planType === 'C' ? 'plan-c' : '');
        return events.map((e, eIdx) => {
            let opts = iconOpts.map(o => `<option value="${o.v}" ${e.type===o.v?'selected':''}>${o.l}</option>`).join('');
            let [hh, mm] = (e.time || "09:00").split(':');
            let commonCheck = '';
            let rowClass = typeClass;
            
            if(planType === 'A' && tripData.useMulti) {
                if(e.isCommon) rowClass += ' is-common';
                commonCheck = `<div class="flex items-center gap-1 mt-1 ml-1"><input type="checkbox" id="chk-com-${dIdx}-${eIdx}" ${e.isCommon?'checked':''} onchange="updateEvent(${dIdx}, ${eIdx}, 'A', 'isCommon', this.checked)"><label for="chk-com-${dIdx}-${eIdx}" class="text-xs font-bold text-yellow-600 cursor-pointer select-none">${L.applyAll}</label></div>`;
            }

            return `<div class="event-item ${rowClass}"><button class="absolute top-2 right-2 text-red-400 text-xs font-bold" onclick="removeEvent(${dIdx}, ${eIdx}, '${planType}')">X</button><div class="flex gap-2 mb-1 items-center"><div class="time-select-group"><select class="time-select" onchange="updateTime(${dIdx}, ${eIdx}, '${planType}', 'h', this.value)">${getHourOpts(hh)}</select><span>:</span><select class="time-select" onchange="updateTime(${dIdx}, ${eIdx}, '${planType}', 'm', this.value)">${getMinOpts(mm)}</select></div><select class="input-field w-24" onchange="updateEvent(${dIdx}, ${eIdx}, '${planType}', 'type', this.value); updateEvent(${dIdx}, ${eIdx}, '${planType}', 'icon', this.options[this.selectedIndex].text.substring(0,2))">${opts}</select><input class="input-field flex-1" value="${e.title}" placeholder="${L.phTitle}" onchange="updateEvent(${dIdx}, ${eIdx}, '${planType}', 'title', this.value)"></div><input class="input-field text-sm mb-1" value="${e.desc}" placeholder="${L.phDesc}" onchange="updateEvent(${dIdx}, ${eIdx}, '${planType}', 'desc', this.value)"><div class="relative"><input class="input-field text-sm" value="${e.map||''}" placeholder="${L.phMap}" onchange="updateEvent(${dIdx}, ${eIdx}, '${planType}', 'map', this.value)"></div>${commonCheck}</div>`;
        }).join('');
    }

    function updateDay(idx, key, val) { tripData.days[idx][key] = val; }
    function removeDay(idx) { if(confirm('Delete Day?')) { tripData.days.splice(idx, 1); render(); } }
    function addDay() { if(tripData.days.length >= 10) { alert('Max 10 Days!'); return; } tripData.days.push({date:"Day "+(tripData.days.length+1), title:"", eventsA:[], eventsB:[], eventsC:[]}); render(); }
    function switchDayTab(dIdx, tab) { tripData.days[dIdx]._activeTab = tab; render(); }
    function addEvent(dIdx, plan) { const newEv = {time:"09:00", type:"map", icon:"ğŸ“", title:"", desc:"", map:"", isCommon: false}; if(plan==='A') tripData.days[dIdx].eventsA.push(newEv); else if(plan==='B') tripData.days[dIdx].eventsB.push(newEv); else tripData.days[dIdx].eventsC.push(newEv); render(); }
    function removeEvent(dIdx, eIdx, plan) { if(plan==='A') tripData.days[dIdx].eventsA.splice(eIdx,1); else if(plan==='B') tripData.days[dIdx].eventsB.splice(eIdx,1); else tripData.days[dIdx].eventsC.splice(eIdx,1); render(); }
    function updateEvent(dIdx, eIdx, plan, key, val) { if(plan==='A') tripData.days[dIdx].eventsA[eIdx][key]=val; else if(plan==='B') tripData.days[dIdx].eventsB[eIdx][key]=val; else tripData.days[dIdx].eventsC[eIdx][key]=val; if(key==='isCommon') render(); }
    function updateTime(dIdx, eIdx, plan, part, val) { let targetArr = (plan==='A')?tripData.days[dIdx].eventsA:(plan==='B')?tripData.days[dIdx].eventsB:tripData.days[dIdx].eventsC; let current=targetArr[eIdx].time||"09:00"; let [hh,mm]=current.split(':'); if(part==='h') hh=val; else mm=val; targetArr[eIdx].time=`${hh}:${mm}`; }
    function addCheck() { tripData.checks.push({text:"", type:"all"}); render(); }
    function addInfo() { tripData.infos.push({label:"", val:"", type:"link"}); render(); }
    
    function saveWork() { 
        tripData.title = document.getElementById('appTitle').value;
        if(tripData.useMulti) { tripData.planA=document.getElementById('planAName').value; tripData.planB=document.getElementById('planBName').value; tripData.planC=document.getElementById('planCName').value; }
        localStorage.setItem('myTripDataV13', JSON.stringify(tripData));
        alert('Saved!');
    }
    
    window.onload = function() {
        const saved = localStorage.getItem('myTripDataV13');
        if(saved && confirm('Load previous work?')) tripData = JSON.parse(saved);
        render();
    }

    function getViewerUrl() {
        saveWork();
        const minified = {
            t: tripData.title, th: tripData.theme, um: tripData.useMulti,
            pa: tripData.planA, pb: tripData.planB, pc: tripData.planC,
            ck: tripData.checks.map(c => ({x:c.text, y:c.type})),
            if: tripData.infos.map(i => ({l:i.label, v:i.val, y:i.type})),
            ds: tripData.days.map(d => ({
                d: d.date, t: d.title,
                ea: d.eventsA.map(e => ({t:e.time, y:e.type, i:e.icon, l:e.title, d:e.desc, m:e.map, c:e.isCommon?1:0})),
                eb: d.eventsB.map(e => ({t:e.time, y:e.type, i:e.icon, l:e.title, d:e.desc, m:e.map})),
                ecp: d.eventsC.map(e => ({t:e.time, y:e.type, i:e.icon, l:e.title, d:e.desc, m:e.map}))
            }))
        };
        const jsonStr = JSON.stringify(minified);
        const compressed = LZString.compressToEncodedURIComponent(jsonStr);
        let baseUrl = window.location.href.replace('builder.html', 'index.html');
        if (!baseUrl.includes('index.html')) {
            baseUrl = baseUrl.split('?')[0]; 
            baseUrl = baseUrl.substring(0, baseUrl.lastIndexOf('/') + 1) + 'index.html';
        }
        return baseUrl + "#d=" + compressed; 
    }

    function openApp() { window.open(getViewerUrl(), '_blank'); }
    function copyLink() { navigator.clipboard.writeText(getViewerUrl()).then(() => alert("Link Copied!")); }
</script>
</body>
</html>